name: 'Update Domain List'

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 10 15 * *' # At 10:00 on day-of-month 15

env:
  FOLDER: 'cloudflare/lists'

jobs:
  auto-update:
    runs-on: ubuntu-22.04

    permissions:
      id-token: write
      contents: write
      pull-requests: write
      actions: write

    steps:
      - name: ðŸ“‚ Checkout Branch
        uses: actions/checkout@v4

      #
      # Fetch domain list
      #
      - name: ðŸ”— Fetch Domain List
        working-directory: ${{ env.FOLDER }}
        run: |
          # Number of entries: ~290,311 (fits within 300 lists limit)
          LIST_URL="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/hosts/multi.txt"
          LIST_FNAME="pihole_domain_list.txt"

          echo "[*] Fetching list: ${LIST_URL} -> ${LIST_FNAME}"
          wget --quiet $LIST_URL -O $LIST_FNAME

          echo "[*] Sorting list..."
          sort -u -o $LIST_FNAME $LIST_FNAME

          echo "[*] Removing comments..."
          grep -o '^[^#]*' $LIST_FNAME > temp.txt || true
          mv temp.txt $LIST_FNAME

          echo "[*] Extracting domains..."
          cat $LIST_FNAME | awk '{ print $2 }' > temp.txt
          mv temp.txt $LIST_FNAME

          echo "[*] Removing localhost from list..."
          sed -i '/localhost/d' $LIST_FNAME
          sed -i '/127.0.0.1/d' $LIST_FNAME

          echo "[*] Removing empty lines..."
          sed -i '/^$/d' $LIST_FNAME

          echo "[*] Done! List count:"
          wc -l $LIST_FNAME

      #
      # Commit and push directly to main
      #
      - name: ðŸ“¤ Commit and Push
        id: commit
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add cloudflare/lists/pihole_domain_list.txt
          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Update Domain List"
            git push
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: ðŸš€ Trigger Terraform Deploy
        if: steps.commit.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'terraform-deploy.yml',
              ref: 'main'
            })
